# 微信小程序开发

H5 工程（`h5/`）为 uni-app x 项目，同一套代码可发 **H5** 或 **微信小程序**。本文说明如何编译、运行到微信开发者工具，以及 AppID、账号绑定等。

---

## 一、编译与运行方式

### 1. CLI 产物的限制

在**非 HBuilderX** 环境下执行：

- `pnpm run dev:mp-weixin`（开发）
- `pnpm run build:mp-weixin`（生产）

当前 **@dcloudio/vite-plugin-uni** 的产出是 **H5 形态**（`index.html` + `assets/`），**不会**生成微信小程序所需的 `app.json`、`app.js`、`pages/*.wxml` 等。  
因此，用微信开发者工具直接打开 `h5/dist/dev/mp-weixin` 或 `h5/dist/build/mp-weixin` 会报错：**「app.json is not found in the project root directory」**。

要得到**真正的小程序包**（含 `app.json`，可在微信开发者工具中运行），需使用 **HBuilderX**。

### 2. 使用 HBuilderX（推荐）

1. **安装 HBuilderX**  
   从 [HBuilderX 官网](https://hx.dcloud.net.cn/) 下载并安装（建议 4.41+，以支持 uni-app x 编译到微信小程序）。

2. **用 HBuilderX 打开项目**  
   文件 → 打开目录 → 选择本仓库下的 **`h5`** 目录（包含 `manifest.json`、`pages.json`、`App.uvue` 的目录）。

3. **运行到微信开发者工具**  
   菜单：**运行 → 运行到小程序模拟器 → 微信开发者工具**。  
   首次会要求配置微信开发者工具的安装路径；配置后，HBuilderX 会编译并输出**标准微信小程序结构**（含 `app.json`），并可由微信开发者工具打开、预览与上传。  
   若手动导入项目，优先选择 **`h5` 根目录**（已提供 `project.config.json`，`miniprogramRoot` 指向 `unpackage/dist/dev/mp-weixin`）；也可直接导入 `h5/unpackage/dist/dev/mp-weixin`。

4. **后续开发**  
   在 HBuilderX 中修改 `h5` 下源码后，重新执行「运行到小程序模拟器 → 微信开发者工具」即可；或在微信开发者工具中点击「编译」查看已打开的编译产物。

> 若页面出现“背景色缺失/整体样式异常”，先确认导入的是上述目录（尤其不要导入旧的 `h5/dist/dev/mp-weixin`），然后重新编译一次。

### 3. 输出目录（可选）

- **HBuilderX**：输出目录一般为 `h5/unpackage/dist/dev/mp-weixin`（开发）或 `unpackage/dist/build/mp-weixin`（发行）。
- **CLI**：可通过环境变量 `UNI_OUTPUT_DIR`（绝对路径）或 `vite.config.ts` 的 `build.outDir` 指定；微信开发者工具中的「本地目录」需与该输出路径一致。

---

## 二、微信小程序 AppID

- **开发/体验**：`h5/manifest.json` 里 `mp-weixin.appid` 可为模板默认值（如 `wxdebc4de0b5584ca4`），仅用于本地或体验版。
- **正式发布**：在 [微信公众平台](https://mp.weixin.qq.com/) 注册小程序，在「开发 → 开发管理 → 开发设置」中获取 **AppID**，并改到 `h5/manifest.json` 的 `mp-weixin.appid`，否则无法以你的主体发布。

```json
// h5/manifest.json 片段
"mp-weixin": {
  "appid": "你的小程序 AppID",
  "setting": { "urlCheck": false, "es6": true },
  "usingComponents": true
}
```

---

## 三、账号绑定与员工/店长角色

已实现「账号绑定 + 角色映射」：

- 绑定表：`user_account_bind`  
  - `appUserId`：C 端用户（`user_info.id`）  
  - `adminUserId`：后台账号（`base_sys_user.id`）  
  - 一对一唯一绑定
- 小程序 `GET /app/user/info/person` 会返回：  
  - `isEmployee`、`isManager`
- 角色判定来源：绑定的后台账号角色标签（`base_sys_role.label`）  
  - `mini_employee` => 员工权限  
  - `mini_manager` => 店长权限（并自动拥有员工权限）

### 配置步骤

1. 在后台角色管理中创建角色标签：`mini_employee`、`mini_manager`。
2. 给后台账号分配上述角色。
3. 在绑定接口里把 C 端用户绑定到该后台账号。

### 绑定接口（Admin）

- `POST /admin/user/accountBind/save`  
  body: `{ "appUserId": 1, "adminUserId": 2, "remark": "..." }`  
  作用：新增或更新绑定
- `POST /admin/user/accountBind/unbind`  
  body: `{ "appUserId": 1 }`  
  作用：解除绑定
- `GET /admin/user/accountBind/roleAccess?appUserId=1`  
  作用：查看该 C 端用户在小程序端的角色能力
- `GET /admin/user/accountBind/bindInfo?appUserId=1`  
  作用：查看当前绑定详情

### 自动同步（登录 → 后台系统用户）

小程序用户登录后，可自动同步到后台系统用户（`base_sys_user`）并建立绑定关系。

- 触发时机：`/app/user/login/phone`、`/app/user/login/mini`（微信登录链路）
- 配置位置：`server/src/modules/user/config.ts` → `sync`
  - `enable`：是否开启自动同步
  - `usernamePrefix`：默认用户名规则前缀
  - `defaultRoleLabels`：默认角色标签数组
  - `autoBindByPhone`：是否按手机号优先复用后台账号
  - `updateAdminProfileOnLogin`：登录时是否回写后台账号昵称/头像/手机号
  - `defaultTenantIdForAppUser`：小程序用户默认归属的租户 ID（该租户管理员可在「用户管理」中看到）

---

## 四、依赖版本建议

与当前 uni-app x 小程序编译兼容的版本（若遇 “Cannot find module '@dcloudio/uni-app/dist-x/...'” 等，请核对版本一致）：

| 包 | 推荐版本 |
|----|----------|
| `@dcloudio/uni-app` | `3.0.0-alpha-5000120260211001` |
| `@dcloudio/uni-components` | `3.0.0-alpha-5000120260211001` |
| `@dcloudio/vite-plugin-uni` | `3.0.0-alpha-5000120260211001` |
| `vue` | 与 package.json 一致（如 ^3.5.x） |

以上已在 `h5/package.json` 中声明；新增或升级依赖时尽量保持该组合，以免 mp-weixin 编译报错。
