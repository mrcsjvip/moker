# 403 Forbidden 权限排查

## 现象

请求如 `GET /dev/admin/base/sys/chain_headquarters/list` 返回 **403 Forbidden**。

## 原因

后台权限中间件会校验：当前用户角色是否拥有该接口对应的**权限标识**。  
接口路径去掉 `/admin/` 后与权限标识（把 `:` 换成 `/`）一致才算有权限，例如：

- 接口：`/admin/base/sys/chain_headquarters/list` → 需要权限：`base:sys:chain_headquarters:list`
- 该权限来自菜单「总部管理」下的**查询**按钮（perms 中含 `base:sys:chain_headquarters:list`）

若未执行连锁菜单初始化，或当前角色未勾选「总部管理」菜单，或登录后未刷新权限缓存，就会返回 403。

## 处理步骤

### 1. 确保菜单已入库

若尚未执行过连锁菜单初始化，请执行：

```bash
mysql -u root -p your_database < server/sql/init_chain_menu.sql
```

执行后，在「菜单管理」中应能看到：**系统管理 → 连锁管理 → 总部管理 / 门店管理** 及其下的新增/删除/修改/查询等权限。

### 2. 给角色分配菜单

1. 登录超管（如 `admin`）。
2. 进入 **系统管理 → 权限管理 → 角色列表**。
3. 编辑当前登录账号所用的角色（或需要访问总部/门店的账号对应角色）。
4. 在菜单树中勾选 **连锁管理 → 总部管理**（及其下的「查询」等需要的权限），以及 **门店管理**（若需要）。
5. 保存。

### 3. 重新登录

权限会在**登录时**写入缓存（`admin:perms:用户ID`）。修改角色菜单后，该用户需要**重新登录**一次，403 才会消失。

---

## 其他接口 403

- **租户管理**：需先执行 `server/sql/init_tenant_menu.sql`，再在角色中勾选「租户管理」并重新登录。
- **其他业务菜单**：若使用 `init_missing_pages_menu.sql` 只插入了页面菜单（type=1），未插入按钮权限（type=2），则列表/新增/修改等接口可能仍 403，需在「菜单管理」中为该页面补充对应权限，并在角色中勾选后重新登录。

## 超管说明

用户名为 **admin** 的超级管理员会跳过权限校验，拥有所有接口权限。若用 admin 仍出现 403，请检查是否为 token 失效、请求头未带 Authorization 等。
