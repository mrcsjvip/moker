# 本地开发运行说明

本文说明如何在本机同时运行**服务端**、**管理后台（Admin）**、**H5 页面**，并进行联调测试。支持直接跑命令或使用 **Docker Compose** 一键起所有端。

---

## 一、使用 Docker Compose（推荐一键起所有端）

### 环境要求

- 已安装 [Docker](https://docs.docker.com/get-docker/) 与 [Docker Compose](https://docs.docker.com/compose/install/)
- 本机 **MySQL** 已启动，并已创建数据库（默认库名 `moker`，可在 compose 中改 `DB_NAME`）

### 启动

在项目根目录执行：

```bash
docker compose up -d
```

首次会拉镜像并执行各端 `npm install`，稍等片刻后即可访问：

| 端     | 地址                      |
|--------|---------------------------|
| 服务端 | http://localhost:8002     |
| 管理后台 | http://localhost:9000   |
| H5     | http://localhost:9900    |

### 配置说明

- **数据库**：通过环境变量 `DB_HOST`、`DB_PORT`、`DB_USER`、`DB_PASSWORD`、`DB_NAME` 配置。默认 `DB_HOST=host.docker.internal`，表示使用本机 MySQL；若 MySQL 也在 Docker 中，可改为 MySQL 服务名。
- **API 代理**：Admin 与 H5 的 Vite 开发服务器在容器内将接口请求代理到 `server` 服务（`http://server:8001`），无需改前端代码。
- **查看日志**：`docker compose logs -f server`（或 `admin` / `h5`）可查看对应端日志。
- **停止**：`docker compose down`。

### Docker 下调试服务端（Node Inspector）

需要断点调试容器内运行的 server 时：

1. **用调试配置启动**（会开启 Node 的 `--inspect` 并暴露 9229 端口）：
   ```bash
   docker compose -f docker-compose.yml -f docker-compose.debug.yml up -d
   ```

2. **在本机附加调试器**（任选其一）：
   - **Cursor / VS Code**：在项目下新建或使用已有 `.vscode/launch.json`，添加：
     ```json
     {
       "type": "node",
       "request": "attach",
       "name": "Attach to Docker Server",
       "address": "localhost",
       "port": 9229,
       "localRoot": "${workspaceFolder}/server",
       "remoteRoot": "/app/server",
       "skipFiles": ["<node_internals>/**"]
     }
     ```
     然后 F5 或“运行和调试”里选 “Attach to Docker Server”。
   - **Chrome**：打开 `chrome://inspect` → “Configure” 添加 `localhost:9229` → 在 “Remote Target” 里选择对应 target 打开 DevTools。

3. **打断点**：在 `server/src` 下需要断点的文件里打断点，触发请求后即可命中。

4. **日常不调试**：用普通启动即可，不必加 `docker-compose.debug.yml`：
   ```bash
   docker compose up -d
   ```

- **H5 在 Docker 内**：若一直停在 “Compiling…” 或反复编译，多为挂载目录被 Vite 监听导致；已对 `node_modules`、`.pnpm` 等做忽略。若仍异常，建议**仅用 Docker 跑服务端 + Admin**，H5 在本地运行：`cd h5 && UNI_INPUT_DIR=$(pwd) pnpm run dev`。

---

## 二、环境要求（本机直接运行）

- **Node.js** >= 18.x（推荐 20.x）
- **MySQL** >= 5.7（推荐 8.0）
- **pnpm** 或 npm（推荐 pnpm）

---

## 三、服务端（Cool Admin Midway）

### 1. 配置数据库

编辑 `server/src/config/config.local.ts`，按你的本机 MySQL 修改：

```ts
// 示例：本地 MySQL
host: process.env.DB_HOST ?? '127.0.0.1',
port: parseInt(process.env.DB_PORT ?? '3306', 10),
username: process.env.DB_USER ?? 'root',
password: process.env.DB_PASSWORD ?? '123456',
database: process.env.DB_NAME ?? 'cool',
```

确保本机已安装并启动 MySQL，并已创建数据库（如 `cool`），首次运行会按配置自动建表、初始化数据。

### 2. 安装依赖并启动

```bash
cd server
pnpm i
pnpm run dev
```

启动成功后控制台会提示，默认访问：

- **服务端地址**：<http://localhost:8001>

---

## 四、H5 前端（Cool Unix）

### 1. 安装依赖

```bash
cd h5
pnpm i
```

### 2. 启动 H5 开发服务

```bash
pnpm run dev
```

- **H5 地址**：<http://localhost:9900>（见 vite.config.ts 中 `server.port: 9900`）

- 首次运行出现 **「Compiling…」** 时，uni-app x 会编译全部页面，可能需 **1～2 分钟**，请耐心等待；若超过 3 分钟仍无输出，可尝试清缓存后重试：`rm -rf node_modules/.vite`，再执行 `pnpm run dev`。
- 若报错 `path argument must be of type string. Received undefined`，需设置环境变量：`UNI_INPUT_DIR=$(pwd) pnpm run dev`（或 `UNI_INPUT_DIR=/path/to/moker/h5`）。Docker Compose 中已自动设置。

### 3. 对接本地服务端（联调时）

当前 H5 通过代理请求接口，默认指向官方演示地址。若要请求**本机服务端**：

1. 打开 `h5/config/proxy.ts`
2. 将 `dev.target` 改为本地服务端地址，例如：

```ts
dev: {
  target: "http://127.0.0.1:8001",  // 本地服务端
  changeOrigin: true,
  rewrite: (path: string) => path.replace("/dev", "")
},
```

3. 确保 H5 中请求的接口前缀与代理一致（如 `/dev/xxx` 会被转发到 `http://127.0.0.1:8001/xxx`）。

---

## 五、开发测试流程建议

1. **先启服务端**：在 `server` 目录执行 `pnpm run dev`，确认 8001 可访问。
2. **再启 H5**：在 `h5` 目录执行 `pnpm run dev`，浏览器打开 <http://localhost:9900>。
3. **联调接口**：按上面步骤修改 `h5/config/proxy.ts` 指向本地 8001，刷新 H5 即可用本地接口调试。
4. **页面入口**：
   - 用户端：首页、预约、我的等（`pages/index`、`pages/biz`）
   - 员工端：从「我的」进入员工入口，或直接访问子包页面（如店长工作台 `/pages/employee/manager-index`）

---

## 六、可选：管理后台 Admin（本机单独运行）

如需同时跑管理后台（Vue 后台）：

```bash
cd admin
pnpm i
pnpm run dev
```

- **Admin 地址**：<http://localhost:9000>（见 admin/package.json）

Admin 在开发时一般也需配置请求地址指向本地服务端（如 8001），具体见 admin 项目内配置。

---

## 七、常见问题

### 小程序登录后，后台「用户管理」列表看不到数据

- **原因**：项目开启了多租户，用户列表按当前登录管理员的 `tenantId` 过滤。小程序用户写入 `user_info` 时若未设置租户，则 `tenantId` 为 null，租户管理员查询时会被过滤掉。
- **处理**：已在用户模块配置中设置 `sync.defaultTenantIdForAppUser: 1`，新登录的小程序用户会归属到租户 1，租户 1 的管理员即可在「用户管理」中看到。
- 若你的实际租户 ID 不是 1，请修改 `server/src/modules/user/config.ts` 中 `defaultTenantIdForAppUser` 为对应值。
- 已存在的小程序用户（此前 `tenantId` 为 null）：可让用户**重新登录一次小程序**，登录时会自动同步并写入租户 ID；或按需执行：  
  `UPDATE user_info SET tenantId = 1 WHERE tenantId IS NULL;`（将 1 改为你的租户 ID）
