# 已实现功能

当前已在代码与联调中落地的功能，按端划分。目标功能见 [目标功能](./目标功能.md)。

---

## 一、C 端（用户端 / H5·小程序）

### 1. 预约流程

| 功能 | 说明 |
|------|------|
| 选择服务 | 服务列表来自接口 `/app/service/list`，选择后跳转预约填写并携带 serviceId/serviceName |
| 选择门店 | 门店列表 `/app/store/list`，选择后跳转预约页并携带 storeId/storeName/storeAddress |
| 预约填写 | 门店/服务/日期/时段/车辆信息/备注/联系人；提交调用 `POST /app/appointment/my/submit`（自动创建/复用客户与车辆） |
| 预约确认 | 根据预约 id 拉取详情 `GET /app/appointment/my/info`，确认调用 `POST /app/appointment/my/confirm` |
| 我的预约列表 | `GET /app/appointment/my/list?tab=`，tab：all / pending / done / cancelled；支持查看、取消、再次预约 |
| 取消预约 | `POST /app/appointment/my/cancel`，仅待确认/待服务可取消，列表二次确认后调用并刷新 |

### 2. 我的车辆

| 功能 | 说明 |
|------|------|
| 车辆列表 | `GET /app/vehicle/my/list`，按当前用户 customer 查车辆，入口在个人中心 |
| 车辆详情 | `GET /app/vehicle/my/info?id=` |
| 添加车辆 | `POST /app/vehicle/my/add`，提交后跳转列表或继续预约流程 |
| 编辑车辆 | `POST /app/vehicle/my/update`，编辑页与添加页共用 vehicle-edit，通过 id 区分 |
| 删除车辆 | `POST /app/vehicle/my/delete`，列表操作二次确认后调用并刷新 |

### 3. 个人中心与设置

| 功能 | 说明 |
|------|------|
| 联系客服 | 请求 `GET /app/base/config` 取 `service_phone`，有则拨号，无则提示「暂未配置客服电话」 |
| 优惠券 / 消息 / 设置 | 入口存在；消息跳设置内通知页，设置见 set 子包（通用设置、通知设置、关于） |
| 员工入口 | 具备员工/店长权限时显示，跳转员工端今日任务 |
| 店长工作台入口 | 具备店长权限时在员工端个人中心显示，跳转店长工作台首页 |

### 4. 登录与用户信息

| 功能 | 说明 |
|------|------|
| 手机号验证码登录 | `POST /app/user/login/phone`，可选 tenantId（选择门店归属） |
| 微信登录（小程序） | `POST /app/user/login/mini`，用户写入 `user_info`，可选身份同步到后台并绑定角色 |
| 租户列表 | `GET /app/user/login/tenantList`，登录前选择门店（租户） |
| 用户信息 | `GET /app/user/info/person`，返回含 isEmployee、isManager、tenantName（当前门店名） |
| 刷新 Token | `POST /app/user/login/refreshToken` |

---

## 二、员工端

- **入口**：个人中心「员工入口」或直接访问员工子包（需已绑定且具备员工/店长权限，`hasEmployeeAccess()`）。

### 1. 今日任务（employee/index）

| 功能 | 说明 |
|------|------|
| 今日统计 | `GET /app/appointment/employee/todayStats`（今日预约数、已完成数等） |
| 今日任务列表 | `GET /app/appointment/employee/todayList`，展示车牌、车型、服务、预计到店、状态 |
| 签到 | 点击「签到」跳转到店签到页 `sign?id=预约id` |
| 工单执行 | 已签到且已生成工单时显示「工单执行」，跳转 `task?id=工单id` |

### 2. 工单（employee/task-list）

| 功能 | 说明 |
|------|------|
| 进行中工单列表 | `GET /app/workorder/employee/list`，当前技师、状态为进行中的工单 |
| 进入执行页 | 点击卡片跳转 `task?id=工单id` |

### 3. 工单执行（employee/task）

| 功能 | 说明 |
|------|------|
| 工单详情 | `GET /app/workorder/employee/detail?id=`，车牌、服务、客户、施工步骤与进度 |
| 完成本阶段 | `POST /app/workorder/employee/finishStep`，将当前待完成步骤标为已完成 |
| 全部完成提交质检 | `POST /app/workorder/employee/finishQuality`，工单状态改为已完成 |
| 上传施工照片 / 标记异常 | 当前为 Toast 占位，未接真实接口 |
| 扫码登记膜卷 | 跳转物料扫码页 material-scan |

### 4. 到店签到（employee/sign）

| 功能 | 说明 |
|------|------|
| 预约详情 | `GET /app/appointment/employee/detail?id=`，车牌、车型、服务、时段、联系人、备注、客户电话、门店电话 |
| 确认签到 | `POST /app/appointment/employee/signIn`，创建工单并记录签到时间，成功后跳工单执行页 |
| 联系客户 / 联系前台 | 使用详情中的 customerPhone、storePhone 调用 `uni.makePhoneCall` 拨号 |

### 5. 个人中心（employee/profile）

| 功能 | 说明 |
|------|------|
| 本月统计 | `GET /app/workorder/employee/stats`（完成单数、提成、星级等） |
| 店长工作台 | 具备店长权限时显示入口，跳转 manager-index |
| 知识赋能 | 跳转 knowledge（施工视频、膜材速查，当前为前端静态数据） |
| 提成明细 / 消息通知 / 账号安全 | 当前为占位或 Toast |
| 退出登录 | 清除本地并跳转登录页 |

### 6. 知识赋能（employee/knowledge）

- 施工视频、膜材速查：当前为前端静态列表与占位播放，未接后端配置或 CMS。

### 7. 物料扫码（employee/material-scan）

- 扫码登记膜卷：当前为前端占位（调起扫码 + 本地列表），未接「膜材使用记录」等后端接口。

---

## 三、店长端

- **入口**：员工端个人中心「店长工作台」（需店长权限，`hasManagerAccess()`）。

### 1. 店长工作台首页（employee/manager-index）

| 功能 | 说明 |
|------|------|
| 今日统计 | `GET /app/appointment/employee/todayStats`，当日预约数、已到店、施工中、已完成、营业额（预留） |
| 今日预约列表 | `GET /app/appointment/employee/managerTodayList`，含技师名、状态 |
| 查看预约 | 跳转到店签到页 `sign?id=预约id` 查看详情 |
| 改派技师 | 拉取 `GET /app/appointment/employee/technicianList`，选择后 `POST /app/appointment/employee/managerReassign`，成功后刷新 |
| 取消预约 | 二次确认后 `POST /app/appointment/employee/managerCancel`，成功后刷新 |
| 预约列表 | 跳转 manager-appointments |
| 排班/员工 | 跳转 manager-staff |
| 数据概览 | 跳转 manager-stats |
| 营销发放 / 门店设置 | 当前为 Toast 占位 |

### 2. 预约列表（employee/manager-appointments）

| 功能 | 说明 |
|------|------|
| 列表（分 tab） | `GET /app/appointment/employee/managerAppointmentList?tab=`，tab：all / pending / arrived / done / cancelled |
| 查看 | 跳转签到页 `sign?id=预约id` |
| 改派技师 | 同工作台首页，ActionSheet 选技师后调用 managerReassign |
| 取消预约 | 二次确认后调用 managerCancel |

### 3. 员工（employee/manager-staff）

| 功能 | 说明 |
|------|------|
| 员工列表 | `GET /app/appointment/employee/staffList`，同门店员工，含今日接单数、角色（店长/员工）、头像 |
| 查看员工 | 当前为 Toast「查看 XX 今日任务」占位 |

### 4. 数据概览（employee/manager-stats）

| 功能 | 说明 |
|------|------|
| 今日核心指标 | `GET /app/appointment/employee/managerStats`，当日营业额（工单暂无金额字段故为 0）、单量、客单价 |
| 员工绩效排行 | 同上接口返回 rankList（技师今日完成单数排序） |
| 热门服务 TOP | 同上接口返回 topServices（今日按服务统计单数） |

---

## 四、管理后台（Admin）

| 类别 | 功能说明 |
|------|----------|
| 基础权限 | 菜单、角色、用户、部门（组织机构）、租户、参数、日志等 |
| 连锁 | 总部管理、门店管理（含菜单初始化脚本） |
| 用户模块 | 用户列表（含 C 端用户）、账号绑定（appUserId ↔ adminUserId）、绑定后角色访问与同步（mini_employee / mini_manager） |
| 系统配置 | base_sys_conf 按租户隔离，支持 cKey（如 service_phone）按租户配置；App 通过 `GET /app/base/config` 获取业务配置 |
| 配置化 CRUD | 通过 crud-pages 配置新增列表+表单页，无需单独写 Vue 页面 |
| 业务菜单 | 预约/客户/车辆/服务/门店/工单等，可按 menu.json 或 SQL 配置后使用对应列表页 |

---

## 五、服务端接口摘要

| 模块/前缀 | 典型接口 | 说明 |
|-----------|----------|------|
| `/app/user/login/*` | tenantList, tenantInfo, phone, mini, refreshToken, smsCode 等 | 登录、租户、验证码、刷新 Token |
| `/app/user/info/*` | person, updatePerson, updatePassword, logoff, bindPhone, miniPhone | 用户信息与更新 |
| `/app/base/config` | GET | 业务配置（如 service_phone），按租户 |
| `/app/base/comm/*` | param, eps, upload, uploadMode | 参数、实体信息、上传 |
| `/app/service/*` | list, page, info | 服务列表（C 端） |
| `/app/store/*` | list, page, info | 门店列表（C 端/员工端） |
| `/app/appointment/my/*` | list, info, submit, confirm, cancel | C 端我的预约 |
| `/app/appointment/employee/*` | todayList, todayStats, managerTodayList, managerAppointmentList, detail, signIn, managerCancel, managerReassign, technicianList, **staffList**, **managerStats** | 员工/店长预约、签到、改派、取消、员工列表、数据概览 |
| `/app/workorder/employee/*` | list, stats, detail, finishStep, finishQuality | 工单列表、详情、完成阶段、提交质检、员工本月统计 |
| `/app/vehicle/my/*` | list, info, add, update, delete | 我的车辆增删改查 |

---

## 六、H5/小程序 页面与路由（主要）

| 子包/目录 | 页面 | 说明 |
|-----------|------|------|
| pages/index | home, my, template | 首页、我的、模板页 |
| pages/biz | service-select, store, appointment, appointment-confirm, appointment-list, workorder, workorder-progress, coupon, vehicle-list, vehicle-edit | 服务/门店选择、预约流程、我的预约、工单、优惠券、我的车辆 |
| pages/employee | index, task-list, task, sign, profile, knowledge, material-scan, manager-index, manager-appointments, manager-staff, manager-stats | 今日任务、工单、签到、个人中心、知识赋能、物料扫码、店长工作台及子页 |
| pages/set | index, general, notice, about | 设置、通用、通知、关于 |
| pages/user | login, edit, edit-name, edit-description | 登录、编辑资料、编辑昵称/简介 |

- 业务页与员工/店长子页统一使用**系统导航栏**（标题与返回），无页面内 `cl-topbar` 双导航；首页、我的、员工/店长部分入口页使用 `navigationStyle: custom` 保留自定义顶栏。

---

## 七、数据与配置

| 项 | 说明 |
|----|------|
| 多租户 | 租户隔离（tenantId）；小程序用户可配置默认归属租户（如 defaultTenantIdForAppUser） |
| 系统配置 | base_sys_conf 唯一键 (tenantId, cKey)；全局用 tenantId=null，租户优先后回退全局 |
| 客服电话 | 后台在「系统配置」中维护 service_phone（按租户），C 端「联系客服」从 `/app/base/config` 读取并拨号 |
| 员工/店长身份 | 通过账号绑定与后台角色（mini_employee、mini_manager）同步，`/app/user/info/person` 返回 isEmployee、isManager、tenantName |

---

以上为当前已实现功能概览；目标与规划见 [目标功能](./目标功能.md)。
