# 服务端开发

基于 **Cool Admin Midway**（Midway.js + TypeORM）的后端，提供 REST 接口供 Admin、H5、微信小程序调用。

---

## 一、技术栈与目录

- **框架**：Midway.js（Koa）
- **ORM**：TypeORM，实体在 `server/src/modules/*/entity/`
- **多租户**：BaseEntity 含 `tenantId`；请求上下文可带租户与用户信息
- **运行**：见 [本地运行指南](./本地运行指南.md)

### 目录结构（简要）

```
server/
├── src/
│   ├── config/              # 全局配置
│   ├── modules/             # 业务模块
│   │   ├── base/            # 基础：菜单、角色、用户、部门、租户、系统配置等
│   │   ├── user/            # C 端用户、登录、账号绑定、身份同步
│   │   ├── appointment/     # 预约（C 端 my、员工/店长 employee）
│   │   ├── workorder/       # 工单（员工执行、统计）
│   │   ├── vehicle/         # 车辆（C 端 my/list）
│   │   ├── customer/        # 客户
│   │   ├── store/           # 门店
│   │   ├── service/         # 服务项目
│   │   └── ...
│   └── middleware/
├── sql/                     # 建表、初始化、迁移
│   ├── init.sql
│   ├── migrate_conf_tenant.sql
│   └── ...
└── package.json
```

每个模块通常包含：

- `entity/`：表定义
- `controller/admin/`：后台管理接口（需 Admin 登录）
- `controller/app/`：C 端 / 员工 / 店长接口（需 App 登录或匿名）
- `service/`：业务逻辑

---

## 二、配置

### 数据库

- 本地：`server/src/config/config.local.ts`，可配合环境变量 `DB_HOST`、`DB_PORT`、`DB_USER`、`DB_PASSWORD`、`DB_NAME`。
- 首次运行若 `synchronize: true` 会按实体建表；生产建议关闭，用 `sql/init.sql` 或迁移脚本。

### 用户模块（C 端登录与同步）

- 配置：`server/src/modules/user/config.ts`
- **sync**：小程序/手机号登录后是否同步到后台账号、是否按手机号复用、默认租户 `defaultTenantIdForAppUser` 等。
- 小程序用户主表：`user_info`（见 [小程序登录与用户表](../ref/app-login-user-table.md)）。

### 系统配置（按租户）

- 表：`base_sys_conf`，唯一键 `(tenantId, cKey)`，`tenantId=null` 表示全局。
- 服务：`BaseSysConfService`，`getValue(key, tenantId?)`、`getValues(keys[], tenantId?)`、`updateVaule`、`setValue`。
- App 获取业务配置：`GET /app/base/config`，返回如 `{ service_phone: "..." }`，按当前用户租户回退全局。
- 后台管理：系统配置 CRUD，支持按租户维护（见 Admin 菜单）。

---

## 三、多租户与权限

- **租户**：`base_sys_tenant`，管理员、数据按 `tenantId` 隔离。
- **App 端**：接口可从 `ctx.user.tenantId` 取当前用户租户；未登录或 C 端无租户时可为 null。
- **员工/店长**：通过 `user_account_bind` 绑定后台账号，角色标签 `mini_employee` / `mini_manager` 决定权限；接口内可用 `getTenantId()` 等做门店级校验。

---

## 四、常用接口前缀（App）

| 前缀 | 说明 |
|------|------|
| `/app/user/login/*` | 手机号/微信登录 |
| `/app/user/info/*` | 个人信息、角色能力 |
| `/app/base/config` | 业务配置（如客服电话） |
| `/app/service/list` | 服务列表 |
| `/app/store/list` | 门店列表 |
| `/app/appointment/my/*` | C 端我的预约 |
| `/app/appointment/employee/*` | 员工/店长预约与签到、改派、取消 |
| `/app/workorder/employee/*` | 工单详情、统计、完成阶段、提交质检 |
| `/app/vehicle/my/list` | 我的车辆 |

详细接口与已实现功能见 [已实现功能](../feature/已实现功能.md)。

---

## 五、扩展与规范

- 新增模块：可参考 `server/.cursor/rules/` 下的 module、controller、service、db、tenant 等规范。
- 新增实体：放在对应模块 `entity/`，继承 BaseEntity 即带 `tenantId`；若需唯一键按租户隔离，参考 `base_sys_conf` 的 `(tenantId, cKey)`。
- SQL 变更：新增表或索引可写在 `sql/` 下并注明用途；大表或生产变更建议单独迁移脚本。
