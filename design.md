# 贴膜门店管理系统 - 设计说明（V1.0）

本设计基于 `requirements.md` 与 `.cursorrules`，并参考 `cool-admin-midway` 与 `cool-admin-vue` 的工程风格，覆盖首期 MVP 范围。

## 1. 目标与范围
- 目标：客户体验数字化、施工流程标准化、门店运营可视化、总部管控一体化
- 范围：多租户门店管理后台、C 端 H5、员工端 H5（同一 H5 入口区分角色）
- 非范围：IoT、AI 质检、供应链与保险合作（作为后续演进）

## 2. 端与角色划分
- 后端服务（`/server` 或 `/api`）：统一鉴权、业务聚合、数据隔离
- 管理后台（`/admin` 或 `/web`）：总部管理员 + 门店店长
- H5 端（`/h5` 或 `/mobile`）：车主用户 + 门店员工 + 总部管理员 + 门店店长（轻量操作与移动便捷入口）

角色与权限：
- 总部管理员（Tenant Admin）：跨租户管理、全局配置、审计
- 门店店长（Store Manager）：本店运营管理
- 门店员工：工单执行与质检
- 车主用户：预约、进度、评价、售后

## 3. 技术栈建议
- 后端：Node.js + TypeScript + Midway（Koa 风格），ORM 使用 Prisma 或 TypeORM
- 管理后台：Vue 3 + Vite + Element Plus + Pinia
- H5：Vue 3 或 React（移动端优先）
- 通用：ES Modules、严格 TS、统一错误处理、结构化日志

### 3.1 小程序一套代码多端方案
- 技术选型：优先 `uni-app`（Vue 3 体系）或 `Taro`（React 体系），与 H5 共用同一业务代码与组件体系。
- 共享层：抽离 `api-client`、`auth`、`stores`、`utils`、`types`，保证业务逻辑与数据模型一致。
- 适配层：针对平台差异封装 `storage`、`upload`、`location`、`pay`、`notify` 等能力。
- 路由与权限：同一份路由表，基于角色与端能力动态启用页面。
- 构建输出：同一仓库内配置多目标构建，分别输出 H5、微信小程序、抖音小程序。

## 4. 核心模块划分
### 4.1 后端模块
- 认证与权限：RBAC + Tenant Scope，支持总部跨租户切换
- 租户与门店：门店创建、停用、负责人、城市
- 客户与车辆：车主档案、车辆绑定、标签
- 服务与商品：服务项目、膜材库、价格、SOP
- 预约与工单：预约排期、技师分配、阶段状态
- 施工记录：阶段图片/视频、质检结果、异常记录
- 库存与溯源：膜卷编号、入库/出库、使用记录
- 营销与优惠：优惠券、裂变、生日礼包
- 报表与统计：营收、单量、客单价、排行
- 合规与审计：操作日志、数据穿透查询

### 4.2 管理后台模块（总部 + 门店）
- 门店与员工管理
- 服务/商品/库存
- 预约与工单管理
- 营销工具与数据报表
- 全局配置（总部）

### 4.3 H5 模块（车主 + 员工 + 管理角色）
车主端：
- 账号与车辆、服务浏览、在线预约、订单追踪、售后评价
员工端：
- 今日任务、工单执行、施工照片上传、异常记录、个人业绩
管理角色（总部/店长）：
- 快速查看门店关键指标、审批与审核、异常工单处理、消息触达

## 5. 关键业务流程
### 5.1 预约 → 工单
1) 车主选择门店/时段/服务 → 创建预约  
2) 门店确认并分配技师 → 生成工单  
3) 施工阶段更新与影像上传 → 工单完成  
4) 自动发放质保卡与评价入口  

### 5.2 施工溯源
- 施工阶段扫码录入膜卷编号
- 工单完成后可回溯：采购批次 → 门店入库 → 工单使用

## 6. 多租户与权限设计
- 所有业务表包含 `tenant_id`
- API 网关/中间件统一校验 `X-Tenant-ID`
- 总部可切换租户上下文，审计记录包含“操作者 + 目标租户”

## 7. 数据模型（核心表）
- tenants（门店）
- users（总部/门店/员工）
- roles / permissions / role_permissions
- customers / vehicles
- services / materials / material_batches
- inventories / inventory_logs
- appointments / work_orders / work_order_steps
- work_order_media（施工图片/视频）
- coupons / coupon_uses
- audits / operation_logs

## 8. API 设计约定
- RESTful + 版本前缀：`/api/v1`
- 统一响应：`{ code, message, data, traceId }`
- 统一错误码与日志追踪

## 9. 非功能性要求
- 性能：工单列表 < 1s；图片上传支持断点续传
- 安全：敏感字段脱敏；影像访问鉴权
- 兼容：H5、微信小程序、抖音小程序、企业微信嵌入
- 离线：员工端支持离线暂存与恢复同步

## 10. 部署与运维
- Docker 化部署，提供 `/health`
- 支持环境变量配置：`PORT`、`DB_URL`、`JWT_SECRET`

## 11. 后续演进
- AI 质检、IoT 传感、供应链补货、膜损险
